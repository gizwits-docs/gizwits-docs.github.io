
<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">

  <title>GoKit3(S)二次开发-程序详解（旧） - 机智云</title>

  <meta http-equiv="X-UA-Compatible" content="IE=Edge, chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <meta name="Description" content="GoKit3(S)二次开发-程序详解（旧）-机智云">
  <meta name="keywords" content="GoKit3(S)二次开发-程序详解（旧） docs 文档中心 Gizwits">

  <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon">
  <script src="/js/redirect.js"></script>

  <link rel="stylesheet" href="/css/pure.min.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/documentation.css?v=db6111caa3d210b6cb1d2dac5119d7c5">
  <link rel="stylesheet" href="/css/share.min.css">
</head>
  <body>
    <div class="header">
  <div class="container pure-g">
    <span class="brand pure-u-5-24">
      <a href="http://www.gizwits.com" class="logo">
      
      <img src="/images/logo.png" alt="logo">
      
      </a>
      <a class="text" href="/">文档中心</a>
    </span>

    <div class="mobile-header"v>
      <span class="title">机智云 文档中心</span>
      <i class="fa fa-caret-square-o-down fa-lg" aria-hidden="true"></i>
    </div>

    <span class="menu pure-u-16-24">
      <span class="header-search-btn" id="header-search-btn">
        <i class="fa fa-search"></i>
      </span>
      <ul class="levelA-wrapper">
        
          
            <li class="levelA"><a href="/zh-cn/overview/overview.html">平台概述</a></li>
          
        
          
            <li class="levelA">
              快速入门 &#9662;
              <ul class="levelB-wrapper">
                
                  
                    <li class="levelB"><a href="/zh-cn/quickstart/5分钟了解机智云.html">5分钟了解机智云</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/quickstart/noun.html">机智云名词定义解释</a></li>
                  
                
              </ul>
            </li>
          
        
          
            <li class="levelA">
              应用开发 &#9662;
              <ul class="levelB-wrapper">
                
                  
                    <li class="levelB"><a href="/zh-cn/quickstart/准备工作.html">App开发准备工作及向导</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/UserManual/devApp.html">App代码自动生成服务介绍</a></li>
                  
                
                  
                    <li class="levelB has-submenu">
                      App 开源框架 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/iosframe.html">iOS 开源框架说明(含源码)</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/iOS消息推送.html">iOS 消息推送</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/iOS第三方登陆与换肤.html">iOS 第三方登录与换肤</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/quickstart/iOSAPPFrame.html">iOS开源框架的快速开发实例</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/Android开源框架使用指南.html">Android 开源框架说明（含源码）</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/Android消息推送.html">Android 消息推送</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/Android第三方登录与换肤.html">Android 第三方登录与换肤</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/quickstart/AndroidAppFrame.html">Android开源框架的快速开发实例</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/APICloudFrame.html">APICloud开源框架使用指南(含源码)</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/开源框架视频教程.html">开源框架使用视频教程</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB has-submenu">
                      App 开发 SDK &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/iOSSDKA2.html">iOS SDK</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/AndroidSDKA2.html">Android SDK</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/APICloudWifiSDK.html">APICloud SDK</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/SDK数据透传方法解析.html">SDK数据透传方法解析</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/SDK调试日志抓取教程.html">SDK调试日志抓取教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/sdk_error.html">SDK错误码列表</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/WechatDev/了解微信应用开发.html">了解微信应用开发</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/WechatDev/WeChatDev.html">微信应用开发教程</a></li>
                  
                
                  
                    <li class="levelB has-submenu">
                      更多教程 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/Cloud/SharingSDK.html">设备分享功能SDK使用流程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/AppDev/third-party.html">第三方登录平台申请流程</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/AppDev/应用开发FAQ.html">应用开发FAQ</a></li>
                  
                
              </ul>
            </li>
          
        
          
            <li class="levelA">
              设备接入 &#9662;
              <ul class="levelB-wrapper">
                
                  
                    <li class="levelB"><a href="/zh-cn/deviceDev/设备接入准备工作及向导.html">设备接入准备工作及向导</a></li>
                  
                
                  
                    <li class="levelB has-submenu">
                      设备快速接入机智云流程 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/quickstart/UseMCU_BK.html">MCU+WiFi通讯模组接入机智云流程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/UseSOC_BK.html">通讯模组SoC方案接入机智云流程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/G510_Project.html">MCU+2G/4G通讯模组接入机智云流程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/NB_Project.html">MCU+NB通讯模组接入机智云流程</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/module_source/module_source.html">模块硬件资料</a></li>
                  
                
                  
                    <li class="levelB has-submenu">
                      GAgent通讯模组使用教程 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/gagent_info.html">GAgent详细介绍</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/串口工具使用文档.html">串口工具使用文档</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/GN511_use.html">GN511使用说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/GR515使用说明.html">GR515使用说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/HF-LPB100串口烧写说明.html">HF-LPB100串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/HF-LPT120.html">HF-LPT120串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/HF-LPT230.html">HF-LPT230串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/MXCHIP串口烧写说明.html">MXCHIP串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/ESP8266串口烧写说明.html">ESP8266串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/ESP-WROOM-02Duart.html">ESP-WROOM-02D串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/G510.html">广和通G510模组烧写方法</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/N102_DTU.html">零零 N102 串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/Air202.html">合宙 Air202 串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/NC3_uart.html">域格 NC3 串口烧写说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/BC23M.html">博实结BC23M模组使用说明</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/debug/NB_Project.html">NB 接入方案</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/通讯模组调试日志抓取教程.html">通讯模组调试日志抓取教程</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB has-submenu">
                      WiFi模组接入方案 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/WiFi_Module/A101模组接入机智云方案及问题排查指引.html">A101模组接入机智云方案及问题排查指引</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/WiFi_Module/ESP-WROOM-02DCUC接入机智云方案及问题排查指引.html">ESP-WROOM-02DCUC接入机智云方案及问题排查指引</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/安信可ESP8266接入机智云方案及问题排查指引.html">安信可ESP8266系列接入机智云方案及问题排查指引</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/HF-LPX30系列接入机智云方案及问题排查指引.html">HF-LPX30系列接入机智云方案及问题排查指引</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/HF-LPX20系列接入机智云方案及问题排查指引.html">HF-LPX20系列接入机智云方案及问题排查指引</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB has-submenu">
                      MCU代码自动生成服务介绍 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/DevSDK/代码自动生成工具.html">MCU代码自动生成工具使用教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/GoKit3_DEV_SDK_Common_transplant.html">MCU SDK 通用平台移植教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/STM32CubeMX_transplant.html">STM32CubeMX移植机智云自动生成代码详解</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/approach_to_tailoring_8051.html">8051平台最小资源裁剪说明</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB has-submenu">
                      开源套件Gokit资料 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/Gokit2使用指南.html">Gokit2 使用指南</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/Gokit3/Gokit3开发套件简介.html">Gokit3系列开发套件简介</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/Gokit3/GoKit3硬件手册.html">Gokit3硬件手册</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/WiFiSOC/GoKit3S使用说明书.html">GoKit3(S)使用说明书</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/WiFiSOC/GoKit3S开发套件介绍.html">Gokit3(S)开发套件介绍</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/WiFiSOC/GoKit3S二次开发.html">GoKit3(S)开发环境搭建</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/WiFiSOC/GoKit-SoC-explanation.html">GoKit-SoC程序详解</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/Gokit3Voice/GoKit-MCU-explanation.html">GoKit-MCU程序详解</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/Gokit4/Gokit4_Dev_Assets.html">Gokit4(G) SoC开发环境搭建、开发指南</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB has-submenu">
                      开发套件Arduino资料 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/ArduinoUNO/ArduinoUNOWiFi_intro.html">ArduinoUNOWiFi接入机智云介绍</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/ArduinoUNO/Tutorial.html">ArduinoUnoWiFi 之ESP8266固件烧写教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/ArduinoUNO/ArduinoUnoWiFi_SDK_API.html">ArduinoUnoWiFi SDK之API介绍</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/ArduinoUNO/example.html">Arduino Uno WiFi智能小夜灯</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB has-submenu">
                      更多接入指南 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/ecevideos.html">ECE Demo开发教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/串口工具使用文档.html">串口工具使用文档</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/STICubeGizwits/STICubeGizwits.html">ST I-CUBE-GizWits套件快速接入指南</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/deviceDev/Onboarding.html">Airlink配网排查引导</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/deviceDev/设备接入FAQ.html">设备接入FAQ</a></li>
                  
                
              </ul>
            </li>
          
        
          
            <li class="levelA">
              云API &#9662;
              <ul class="levelB-wrapper">
                
                  
                    <li class="levelB"><a href="/zh-cn/Cloud/openapi_apps.html">Open API 指南</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/Cloud/ent_dev.html">企业应用开发</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/Cloud/enterprise_api.html">企业API</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/Cloud/NotificationAPI.html">SNoti API</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/Cloud/WebsocketAPI.html">WebSocketAPI</a></li>
                  
                
                  
                    <li class="levelB has-submenu">
                      API使用教程 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/UseOpenAPI.html">使用OpenAPI控制虚拟设备教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/UseSNoti.html">Snoti数据实时同步服务demo使用教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/UseWebsocket.html">使用Websocket 网页控制设备教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/DataAPI.html">使用聚合API教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/LinkageAPI.html">设备联动API使用教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/devgroup_API.html">设备分组API使用教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/UseQRCode.html">APP绑定设备二维码生成教程</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/Cloud/CloudFAQ.html">云端应用FAQ</a></li>
                  
                
              </ul>
            </li>
          
        
          
            <li class="levelA">
              用户手册 &#9662;
              <ul class="levelB-wrapper">
                
                  
                    <li class="levelB"><a href="/zh-cn/UserManual/change.html">个人项目产品转企业项目产品</a></li>
                  
                
                  
                    <li class="levelB has-submenu">
                      OTA使用教程 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/OTA.html">GAgent OTA教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/MCUOTA.html">MCU OTA教程</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/deviceDev/产测工具使用文档.html">产测工具使用文档</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/UserManual/D3.html">D3 Engine使用教程</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/UserManual/ece.html">ECE雾计算使用教程</a></li>
                  
                
                  
                    <li class="levelB has-submenu">
                      语音音箱接入教程 &#9656;
                      <ul class="levelC-wrapper">
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/echo.html">接入Echo开发教程</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/deviceDev/echo.html">使用Echo音箱控制GoKit</a></li>
                        
                          <li class="levelC"><a href="/zh-cn/UserManual/Google_Home_GoKit.html">使用Google Home音箱控制GoKit</a></li>
                        
                      </ul>
                    </li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/UserManual/rtbd.html">实时大数据使用教程</a></li>
                  
                
                  
                    <li class="levelB"><a href="/zh-cn/UserManual/WorldWideConnectSolution.html">全球部署方案</a></li>
                  
                
              </ul>
            </li>
          
        
      </ul>
    </span>

    <span class="pure-u-3-24 lang-switch-wrapper">

      <i class="fa fa-globe" aria-hidden="true"></i>
      
      <a href="/en-us/overview/overview.html" class="lang-switch">English</a>
      
    </span>
  </div>

  <div class="header-search-panel" id="header-search-panel">
    <span class="header-search-close" id="header-search-close"><i class="fa fa-times" aria-hidden="true"></i></span>
    <div class="header-search-input-wrap" id="header-search-input-wrap">
      <input type="text" class="header-search-input" id="header-search-input" placeholder="请输入关键字">
      <span class="header-search-input-icon"><i class="fa fa-search"></i></span>
    </div>

    <div class="header-search-trend" id="header-search-trend">
      <div class="header-search-trend-title">热搜词</div>
      <div class="header-search-trend-items clearfix">
        
        <div class="header-search-trend-item" data-word="APP">APP</div>
        
        <div class="header-search-trend-item" data-word="SDK">SDK</div>
        
        <div class="header-search-trend-item" data-word="Android">Android</div>
        
        <div class="header-search-trend-item" data-word="ios">ios</div>
        
        <div class="header-search-trend-item" data-word="WIFI">WIFI</div>
        
      </div>
    </div>

    <div class="header-search-result hidden" id="header-search-result">
      <div class="header-search-result-head">
        搜索结果 &gt; <span id="header-search-keyword"></span>
      </div>
      <div class="header-search-result-items" id="header-search-result-items">
      </div>
    </div>
  </div>
</div>

    <div class="body">

  <div class="container clearfix">
    <div class="navigation">
      <div class="navigation-inner">
        <div class="nav-title">目录</div>
        <div class="nav"></div>
      </div>
    </div>
    <div class="markdown-body" data-spy="scroll" data-target=".navigation">
      <div class="heading">
        <div class="title">GoKit3(S)二次开发-程序详解（旧）</div>
        <a class="edit-link" target="_blank"><i class="fa fa-github" aria-hidden="true"></i> 文档编辑</a>
      </div>
      <p><strong>2017年9月25日起已使用新版MCU代码生成，<a href="http://docs.gizwits.com/zh-cn/deviceDev/WiFiSOC/GoKit-SoC-explanation.html" target="_blank" rel="noopener">查看新版</a>自动生成代码程序详解</strong></p>
<h1 id="通信协议详解"><a href="#通信协议详解" class="headerlink" title="通信协议详解"></a>通信协议详解</h1><h2 id="1-协议阅读前需知"><a href="#1-协议阅读前需知" class="headerlink" title="1 协议阅读前需知"></a>1 协议阅读前需知</h2><p><strong>A. SOC版与MCU版的区别：</strong></p>
<p>由于SoC方案是直接在WiFi模组上进行开发故没有MCU这一概念，无需进行串口协议传输，没有协议组包和协议解析这些步骤，所以<strong>没有串口协议</strong>，重点是“P0数据区”解析这部分。</p>
<p><strong>B. SOC版与MCU版的联系：</strong></p>
<p>云端生成的协议文档默认是MCU版的协议文档，其实SOC版完全可复用MCU版的协议，故在这里直接将《xxx-机智云接入串口通讯协议文档》中的MCU理解为SOC（后文同理）。</p>
<h2 id="2-“p0-数据区约定”"><a href="#2-“p0-数据区约定”" class="headerlink" title="2 “p0 数据区约定”"></a>2 “p0 数据区约定”</h2><p><strong>“p0 数据区约定”有如下功能：</strong></p>
<p>1) 模块向SOC发送控制命令时携带p0 命令和命令标志位以及可写数据区</p>
<p>2) SOC主动发送状态时或者回复模块的状态查询时携带p0命令和完整数据区</p>
<p>3) 数据区会自动合并布尔和枚举变量，且有严格的顺序，不可任意改变</p>
<p><strong>怎么来理解这三个功能呢？将前序中准备的</strong>《XX-机智云接入串口通讯协议文档》<strong>如打开，我们会看到如下命令：</strong></p>
<p>1）WiFi模组请求设备信息；</p>
<p>2）WiFi模组与设备SOC的心跳；</p>
<p>3）设备SOC通知WiFi模组进入配置模式；</p>
<p>4）设备SOC重置WiFi模组；</p>
<p>5）WiFi模组向设备SOC通知WiFi模组工作状态的变化；</p>
<p>6）WiFi模组请求重启SOC；</p>
<p>7）非法消息通知；</p>
<p>8）WiFi模组读取设备的当前状态；</p>
<p>9）设备SOC向WiFi模组主动上报当前状态；</p>
<p>10）WiFi模组控制设备；<br>（之后非重点省略）</p>
<p>大部分的基础通信协议代码机智云已经为大家实现了，所以我们特别关注<strong>8、9、10</strong>三条命令即可。</p>
<p>我们先关注<strong>命令10</strong>如下：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image3.png" alt="Alt text"></p>
<p>注：SOC版代码无需关注P0协议区以外的协议内容，后文同理。</p>
<p>对应上面“p0 数据区约定”中的<strong>功能1</strong>）“模块向SOC发送控制命令时携带<strong>p0 命令</strong>和<strong>命令标志位</strong>以及<strong>可写数据区</strong>”，可知：“action(1B)”代表p0 命令、“attr_flags(1B）”代表命令标志位、“attr_vals(6B)”代表可写数据区。</p>
<p>那程序中如何识别呢，往下看协议的注解：</p>
<p>1).命令标志位<strong>(attr_flags)</strong>表示相关的数据值是否为有效值，相关的标志位为“1”表示值有效，为“0”表示值无效，从右到左的标志位依次为：</p>
<table>
<thead>
<tr>
<th style="text-align:left">标志位</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">bit0</td>
<td style="text-align:left">设置LED_OnOff</td>
</tr>
<tr>
<td style="text-align:left">bit1</td>
<td style="text-align:left">设置LED_Color</td>
</tr>
<tr>
<td style="text-align:left">bit2</td>
<td style="text-align:left">设置LED_R</td>
</tr>
<tr>
<td style="text-align:left">bit3</td>
<td style="text-align:left">设置LED_G</td>
</tr>
<tr>
<td style="text-align:left">bit4</td>
<td style="text-align:left">设置LED_B</td>
</tr>
<tr>
<td style="text-align:left">bit5</td>
<td style="text-align:left">设置Motor_Speed</td>
</tr>
</tbody>
</table>
<p>这里可以清楚的看到<strong>attr_flags</strong>占1B字节，其中bit0代表：设置LED_OnOff……bit5：设置Motor_Speed，那么对于我们的SOC接收到WIFI发来的控制命令后，我们通过识别<strong>attr_flags</strong>的每一位即可对应出需要控制的设备。</p>
<p>2).设置数据值<strong>(attr_vals(6B))</strong> 即可写数据区，定义如下：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image4.png" alt="Alt text"></p>
<p>这里可以清楚的看到，只有相关的设置标志位<strong>（attr_flags）</strong>为1时，数据值才是有效的，需要特别注意的是“p0 数据区约定”约定第三条，数据区会自动合并布尔和枚举变量，且有严格的顺序，不可任意改变。对应上面的“byte0”合并了“bool”和“enum”类型。</p>
<h2 id="3-协议分析总结"><a href="#3-协议分析总结" class="headerlink" title="3 协议分析总结"></a>3 协议分析总结</h2><p><strong>“p0 数据区约定”</strong>主要作用是完成有效数据的上传(协议4.8、4.9)与下达(协议4.10)，其中<strong>上传协议</strong>的组成形式为：<strong>action(1B) + dev_status(11B)</strong> ; 下达协议的组成形式为：<strong>action(1B) + attr_flags(1B) + attr_vals(6B)</strong> ; 其中：</p>
<table>
<thead>
<tr>
<th style="text-align:left">p0 数据区内容</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">action</td>
<td style="text-align:left">表示”p0 命令”的传输方向，即：WiFi -&gt; MCU 或 MCU -&gt;Wifi</td>
</tr>
<tr>
<td style="text-align:left">dev_status</td>
<td style="text-align:left">表示上报的所有数据点的设备状态</td>
</tr>
<tr>
<td style="text-align:left">attr_flags</td>
<td style="text-align:left">表示有效的控制型数据点</td>
</tr>
<tr>
<td style="text-align:left">attr_vals</td>
<td style="text-align:left">表示有效控制数据点的数据值</td>
</tr>
</tbody>
</table>
<p>至此<strong>“p0 数据区约定”</strong>的解析到此结束，之后我们还会分析SOC的程序实现。</p>
<h1 id="程序详解"><a href="#程序详解" class="headerlink" title="程序详解"></a>程序详解</h1><h2 id="1-代码目录介绍"><a href="#1-代码目录介绍" class="headerlink" title="1 代码目录介绍"></a>1 代码目录介绍</h2><h3 id="1-1-一级目录"><a href="#1-1-一级目录" class="headerlink" title="1.1 一级目录"></a>1.1 一级目录</h3><p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image5.png" alt="Alt text"></p>
<p>说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">文件夹</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">app</td>
<td style="text-align:left">用户目录<strong>（开发者主要关注）</strong></td>
</tr>
<tr>
<td style="text-align:left">bin</td>
<td style="text-align:left">固件生成目录</td>
</tr>
<tr>
<td style="text-align:left">include</td>
<td style="text-align:left">模组驱动相关库</td>
</tr>
<tr>
<td style="text-align:left">ld</td>
<td style="text-align:left">动态链接库</td>
</tr>
<tr>
<td style="text-align:left">lib</td>
<td style="text-align:left">工程文件</td>
</tr>
<tr>
<td style="text-align:left">tools</td>
<td style="text-align:left">相关工具</td>
</tr>
<tr>
<td style="text-align:left">readme.txt</td>
<td style="text-align:left">Gokit3S文档介绍</td>
</tr>
<tr>
<td style="text-align:left">user guide V0.3.pdf</td>
<td style="text-align:left">Gokit3S二次开发导读</td>
</tr>
</tbody>
</table>
<h3 id="1-2-代码文件说明"><a href="#1-2-代码文件说明" class="headerlink" title="1.2 代码文件说明"></a>1.2 代码文件说明</h3><p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image6.png" alt="Alt text"></p>
<p>主要文件说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">文件</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">libgagent.a</td>
<td style="text-align:left">该文件为机智云设备接入协议库文件,文件位于 lib 目录下</td>
</tr>
<tr>
<td style="text-align:left">gagent_external.h</td>
<td style="text-align:left">该文件为 libgagent.a 对应头文件,两个文件配合使用</td>
</tr>
<tr>
<td style="text-align:left">gizwits_product.c</td>
<td style="text-align:left">该文件为平台相关处理文件，存放事件处理API接口函数，即 gizwitsEventProcess()</td>
</tr>
<tr>
<td style="text-align:left">gizwits_product.h</td>
<td style="text-align:left">该文件为 gizwits_product.c 的头文件，存放产品相关宏定义如： HARDWARE_VERSION 、SOFTWARE_VERSION</td>
</tr>
<tr>
<td style="text-align:left">gizwits_protocol.c</td>
<td style="text-align:left">该文件为协议实现文件，存放 SDK API 接口函数</td>
</tr>
<tr>
<td style="text-align:left">gizwits_protocol.h</td>
<td style="text-align:left">该文件为 gizwits_protocol.c 对应头文件，协议相关宏定义以及 API 接口声明均在此文件中。</td>
</tr>
</tbody>
</table>
<h3 id="1-3-协议API介绍"><a href="#1-3-协议API介绍" class="headerlink" title="1.3 协议API介绍"></a>1.3 协议API介绍</h3><table>
<thead>
<tr>
<th style="text-align:left">API 名称</th>
<th style="text-align:left">API 功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">void gizwitsInit(void)</td>
<td style="text-align:left">gizwits协议初始化接口。用户调用该接口可以完成Gizwits协议相关初始化（包括协议相关定时器、串口的初始化）。</td>
</tr>
<tr>
<td style="text-align:left">void gizwitsSetMode(uint8_t mode)</td>
<td style="text-align:left">参数mode[in]：仅支持0,1和2,其他数据无效。参数为0，恢复模组出厂配置接口，调用会清空所有配置参数，恢复到出厂默认配置。参数为1时配置模组进入SoftAp模式；参数为2配置模组进入AirLink模式。</td>
</tr>
<tr>
<td style="text-align:left">void gizwitsHandle(dataPoint_t *dataPoint)</td>
<td style="text-align:left">参数dataPoint[in]:用户设备数据点。该函数中完成了数据上报等相关操作。</td>
</tr>
<tr>
<td style="text-align:left">int8_t gizwitsEventProcess (eventInfo_t <em>info, uint8_t </em>data, uint32_t len)</td>
<td style="text-align:left">参数info[in]:事件队列 参数data[in]:数据 参数len [in]:数据长度 用户数据处理函数,包括wifi状态更新事件和控制事件。 a)Wifi状态更新事件 WIFI_开头的事件为wifi状态更新事件，data参数仅在WIFI_RSSI有效，data值为RSSI值,数据类型为uint8_t，取值范围0~7。 b)控制事件 与数据点相关,本版本代码会打印相关事件信息，相关数值也一并打印输出，用户只需要做命令的具体执行即可。</td>
</tr>
</tbody>
</table>
<h2 id="2-程序实现原理"><a href="#2-程序实现原理" class="headerlink" title="2 程序实现原理"></a>2 程序实现原理</h2><p><strong>协议实现机制：</strong></p>
<p>协议解析后，将P0数据区的有效数据点生成对应的数据点事件，再按事件处理数据点。</p>
<p><strong>数据点转换事件的说明</strong>：</p>
<p>根据协议P0数据区的attr_flags位判断出有效数据点，并将其转化成对应的数据点事件，然后在事件处理函数中(gizEventProcess)完成事件的处理。</p>
<h2 id="3-程序初始化说明"><a href="#3-程序初始化说明" class="headerlink" title="3 程序初始化说明"></a>3 程序初始化说明</h2><h3 id="3-1-数据协议结构体的定义"><a href="#3-1-数据协议结构体的定义" class="headerlink" title="3.1 数据协议结构体的定义"></a>3.1 数据协议结构体的定义</h3><p>结构体<strong>dataPoint_t</strong>  ，代码位置: <strong>gokit_mcu_stm32_xxx\Gizwits\gizwits_protocol.h</strong></p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image7.png" alt="Alt text"></p>
<p>说明：结构体<strong>dataPoint_t</strong>，作用是存储用户区的设备状态信息，用户根据云端定义的数据点向其对应的数据位赋值后便不需关心数据的转换，其数据位分别对应<strong>“p0 数据区约定”</strong>中的<strong>“4.9 设备MCU向WiFi模组主动上报当前状态”</strong>中的：dev_status(11B) 位：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image8.png" alt="Alt text"></p>
<p><strong>attrFlags_t、attrVals_t</strong> ，代码位置: <strong>gokit_mcu_stm32_xxx\Gizwits\gizwits_protocol.h</strong></p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image9.png" alt="Alt text"></p>
<p>结构体attrFlags_t、attrVals_t分别对应<strong>“p0 数据区约定”</strong>中的<strong>“4.10 WiFi模组控制设备”</strong>中的：attr_flags(1B) + attr_vals(6B)位：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image10.png" alt="Alt text"></p>
<p><strong>devStatus_t</strong>，代码位置: <strong>gokit_mcu_stm32_xxx\Gizwits\gizwits_protocol.h</strong></p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image11.png" alt="Alt text"></p>
<p>结构体<strong>devStatus_t</strong>对应“<strong>p0 数据区约定”</strong>中的<strong>“4.9 设备MCU向WiFi模组主动上报当前状态”</strong>中的：dev_status(11B) 位：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/12.png" alt="Alt text"></p>
<p><strong>特别说明：</strong></p>
<p>A. 数据结构说明</p>
<p>dataPoint_t 为应用层数据结构，开发者需要了解并会使用（具体使用方式请查看：<strong>“2.7.1 只读型数据的获取”</strong>一节）。</p>
<p><strong>attrFlags_t、attrVals_t、devStatus_t</strong>为通信层数据结构，开发者需要结合通讯协议进行理解。</p>
<p>B. 位段举例说明：</p>
<p><strong>uint8_t motor_switch:1;</strong> 是一种位段的使用方式。因为 uint8_t型数据占用 8bit（8位）的空间，协议中<strong>motor_switch占用</strong>字段bit0（第一位）所以uint8_t motor_switch:1表示使用<strong>1位</strong>的空间。</p>
<p><strong>uint8_t reserve:7;</strong> 因为程序中申请内存时的最小单位是byte(字节)，而这里我们是按bit(位，8bit = 1byte)进行了使用，故需补齐不足1byte的剩余bit(使用n bit后需补齐剩余的8-n bit)。</p>
<p><strong>注：位段不能跨字节操作，否则会造成数据读写错误。</strong></p>
<h3 id="3-2-程序主函数"><a href="#3-2-程序主函数" class="headerlink" title="3.2 程序主函数"></a>3.2 程序主函数</h3><p>位置：<strong>gokit-soc-esp8266\app\user\user_main.c</strong>中user_init() 函数：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image12.png" alt="Alt text"></p>
<p>说明：该函数作为整个系统的程序入口初始化了Gagent模块和Gizwits协议模块这两个主要的部分，其中跟开发者有关的是函数是<strong>gizwitsInit()</strong>、<strong>userTimerFunc()</strong>、<strong>gizwitsUserTask()</strong>，相关说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">gizwitsInit()</td>
<td style="text-align:left">协议解析处理模块初始化函数（协议API）</td>
</tr>
<tr>
<td style="text-align:left">userTimerFunc()</td>
<td style="text-align:left">定时器回调函数（100ms定时周期，与时间相关的开发逻辑可以在这里实现）</td>
</tr>
<tr>
<td style="text-align:left">gizwitsUserTask()</td>
<td style="text-align:left">用户事件回调函数，用户可在该函数中完成相应任务的处理</td>
</tr>
</tbody>
</table>
<h3 id="3-3-用户程序初始化"><a href="#3-3-用户程序初始化" class="headerlink" title="3.3 用户程序初始化"></a>3.3 用户程序初始化</h3><p>位置：<strong>user_main.c</strong>中 <strong>“//user_init 相关程序”</strong></p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image13.png" alt="Alt text"></p>
<p>这部分完成了RGB LED、按键、电机、温湿度、红外传感器的硬件驱动调用，对应的驱动程序实现都在<strong>gokit-soc-esp8266\app\driver</strong>下。</p>
<p>其中完成了定时器初始化（详情查看2.3.4节）：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image14.png" alt="Alt text"></p>
<p>以及系统任务初始化（详情查看2.3.5节）：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image15.png" alt="Alt text"></p>
<h3 id="3-4-定时器使用"><a href="#3-4-定时器使用" class="headerlink" title="3.4 定时器使用"></a>3.4 定时器使用</h3><p>代码位置：app\user\user_main.c 中的user_init()函数</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/16.png" alt="Alt text"></p>
<p>相关宏定义：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image16.png" alt="Alt text"></p>
<p>API说明：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image17.png" alt="Alt text"></p>
<p>回调函数说明：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image18.png" alt="Alt text"></p>
<p>在userTimerFunc() 中完成了周期100ms的定时执行，开发者可以在user_handle()中实现定时读取外设数据的操作，将读取到的数据赋值到用户区的全局结构体变量：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image19.png" alt="Alt text"></p>
<h3 id="3-5-系统任务的使用"><a href="#3-5-系统任务的使用" class="headerlink" title="3.5 系统任务的使用"></a>3.5 系统任务的使用</h3><p>代码位置：<strong>app\user\user_main.c</strong> 中的<strong>user_init()</strong>函数</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/20.png" alt="Alt text"></p>
<p>API使用说明：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image20.png" alt="Alt text"></p>
<p>回调函数说明：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image21.png" alt="Alt text"></p>
<p>开发者可以自定义系统任务(<strong>system_os_post</strong>中的消息类型)，然后在系统任务回调函数中(gizwitsUserTask)添加对应的任务处理(即switch中对应的消息类型)。</p>
<p>需要注意的是：任务优先级不可随意修改（共有三个优先级，提供给开发者的是<strong>优先级0</strong>）：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image22.png" alt="Alt text"></p>
<h2 id="4-配置模式说明"><a href="#4-配置模式说明" class="headerlink" title="4 配置模式说明"></a>4 配置模式说明</h2><p>开发者只有先调用“WiFi配置接口”API才能使WiFi模组进入相应的配置模式，进而完成联网、云端通信的等功能。</p>
<p><strong>“WiFi配置接口”API 位置：gokit_mcu_stm32_xxx\Gizwits\gizwits_protocol.h</strong></p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image23.png" alt="Alt text"></p>
<p>在本示例工程中是通过<strong>按键触</strong>发进入相应的配置模式，程序中触发逻辑位置：<strong>gokit_mcu_stm32_xxx\User\main.c</strong></p>
<p>A.进入Soft AP 模式：key2按键短按。</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image24.png" alt="Alt text"></p>
<p>B.进入AirLink 模式：key2按键长按。</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image25.png" alt="Alt text"></p>
<p>C.模组复位：key1按键长。</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image26.png" alt="Alt text"></p>
<p><strong>注：开发者可以按照自己的需求来实现配置模式。</strong></p>
<h2 id="5-协议处理函数的实现"><a href="#5-协议处理函数的实现" class="headerlink" title="5 协议处理函数的实现"></a>5 协议处理函数的实现</h2><p>位置<strong>：Gizwits\gizwits_protocol.c中gizIssuedProcess()</strong> 函数：</p>
<p>该函数被Gagent模块调用，处理来自云端或APP端的相关p0数据协议。</p>
<p>以下是该协议处理函数的详细介绍：</p>
<p>● 首先是一些局部变量的初始化，比较重要的是<strong>“gizwitsIssued_t *gizIssuedData”</strong>它的作用是保存解析出来的协议包头：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image27.png" alt="Alt text"></p>
<p>协议格式对应协议“4.10 WiFi模组控制设备”中“P0协议区”的标志位”attr_flags” + 数据值”attr_vals”</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image28.png" alt="Alt text"></p>
<p>● 然后是各协议命令的处理流程：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image29.png" alt="Alt text"></p>
<p>由于SOC版相对MCU版去掉了串口协议等概念，故开发者在只需了解《xxx机智云接入串口通信协议文档》中的8、10三条指令：</p>
<table>
<thead>
<tr>
<th style="text-align:left">8）WiFi模组读取设备的当前状态； 10）WiFi模组控制设备；</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<p>● 下面以以协议4.8的处理为例：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image30.png" alt="Alt text"></p>
<p>其“action”值 为“0x02”，对应程序中的的case为<strong>“ACTION_READ_DEV_STATUS”</strong></p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image31.png" alt="Alt text"></p>
<p>之后完成了上报数据的数据类型转化（转化后的数据存储在<strong>gizwitsReport_t</strong>中的devStatus数据位中）：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image32.png" alt="Alt text"></p>
<p>最后将待上报的数据以指针拷贝的方式进行输出：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image33.png" alt="Alt text"></p>
<p>● 同理其他协议action值对应的宏定义的位置在Gizwits\gizwits_protocol.h中:</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image34.png" alt="Alt text"></p>
<p>以上便是p0协议处理函数的详解。</p>
<h2 id="6-控制型协议的实现"><a href="#6-控制型协议的实现" class="headerlink" title="6 控制型协议的实现"></a>6 控制型协议的实现</h2><p>与控制型协议相关的函数调用关系如下：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image35.png" alt="Alt text"></p>
<p>函数调用说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">giziIssuedProcess</td>
<td style="text-align:left">该函数被gagent调用，接收来自云端或app端下发的相关协议数据</td>
</tr>
<tr>
<td style="text-align:left">ACTION_CONTROL_DEVICE</td>
<td style="text-align:left">进行“控制型协议”的相关处理</td>
</tr>
<tr>
<td style="text-align:left">gizDataPoint2Event</td>
<td style="text-align:left">根据协议生成“控制型事件”，并完成相应数据类型的转换</td>
</tr>
<tr>
<td style="text-align:left">gizwitsEventProcess</td>
<td style="text-align:left">根据已生成的“控制型事件”进行相应事件处理（即调用相应的驱动函数）</td>
</tr>
</tbody>
</table>
<h3 id="6-1-控制型事件的生成"><a href="#6-1-控制型事件的生成" class="headerlink" title="6.1 控制型事件的生成"></a>6.1 控制型事件的生成</h3><p>相关代码位置：<br><strong>app\Gizwits\gizwits_protocol.c</strong> 中 gizDataPoint2Event() 函数：</p>
<p>功能说明：<br>在该函数中完成了写类型外设事件的生成，以“红灯开关数据点”为例：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image36.png" alt="Alt text"></p>
<p>这里对应协议<strong>“4.10 WiFi模组控制设备”</strong>：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/37.png" alt="Alt text"></p>
<p>前面我们已经知道程序里的 <strong>“issuedData-&gt;attr_flags”</strong>就对应《微信宠物屋-机智云接入串口通信协议文档.pdf》中的<strong>“4.10 WiFi模组控制设备”</strong>中的<strong>attr_flags(1B)</strong>，作用是用来控制所选位的设备，在文档中我们可以看到attr_flags的第0位是用来选择控制LED灯开关的，即只要设置了第0位为1就表示要控制LED等开关了，代码中对应如下：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image37.png" alt="Alt text"></p>
<p>接下来便是控制型事件的生成：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image38.png" alt="Alt text"></p>
<p>以及完成数据的解压（详情请查看<strong>“2.8.2 数据解压与压缩处理”</strong>一节）：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image39.png" alt="Alt text"></p>
<p>注意：枚举（如<strong>EVENT_LED_ONOFF</strong>）用来直观的表示事件的含义，用户自行添加、更改（位置：<strong>app\Gizwits\gizwits_protocol.h</strong>）<br><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image40.png" alt="Alt text"></p>
<h3 id="6-2-控制型事件处理"><a href="#6-2-控制型事件处理" class="headerlink" title="6.2 控制型事件处理"></a>6.2 控制型事件处理</h3><p>代码位置:<br><strong>app\Gizwits\gizwits_product.c</strong> 中 <strong>gizwitsEventProcess()</strong> 函数：</p>
<p>功能说明：</p>
<p>完成写类型外设事件的处理。</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image41.png" alt="Alt text"></p>
<p>这段程序功能的控制LED灯的开关：LED开关控制位 <strong>“issued-&gt;attr_vals.led_onoff”</strong> 的值若是LED_On（0x01）表示灯开，为LED_Off（0x01）表示灯关。这对应《微信宠物屋-机智云接入串口通信协议文档.pdf》中的<strong>“4.10 WiFi模组控制设备”</strong>中的attr_vals(6B)，即“数据位”，如下所示：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image42.png" alt="Alt text"></p>
<p>第0位用来控制红灯亮灭，对应到在云端定义的数据点含义为：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image43.png" alt="Alt text">    = 0x00 = 红灯灭</p>
<p> <img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image44.png" alt="Alt text">   = 0x01 = 红灯亮</p>
<p>下面的程序基本和上面一样，只要大家看懂了《xxx-机智云接入串口通信协议文档.pdf》中的<strong>“4.10 WiFi模组控制设备”</strong>中的attr_flags(1B) 、attr_vals(6B)这两位就能编写控制型协议的程序了。</p>
<h3 id="6-3-可写型数据类型转换"><a href="#6-3-可写型数据类型转换" class="headerlink" title="6.3 可写型数据类型转换"></a>6.3 可写型数据类型转换</h3><p>接收到来自云端的数据后，由于原始数据经过特殊处理，所以要在<strong>gizDataPoint2Event</strong>中进行相应的数据的转换。</p>
<p>转换函数说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">gizDecompressionValue</td>
<td style="text-align:left">完成传输数据的压缩处理，详情查看“2.8.2 数据解压与压缩处理”一节。</td>
</tr>
<tr>
<td style="text-align:left">gizX2Y</td>
<td style="text-align:left">将用户区数据转化为传输数据，详情查看“2.8.1 数据点类型转换”一节。</td>
</tr>
</tbody>
</table>
<p>程序中对应：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image45.png" alt="Alt text"></p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image46.png" alt="Alt text"></p>
<p>特别说明：</p>
<p>网络字节序转化</p>
<p>数据点为uint16、uint32型的数据要考虑<strong>网络字节序转化</strong>（uint16即使用<strong>exchangeBytes()</strong>函数），以电机控制为例：<br><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image47.png" alt="Alt text"></p>
<h2 id="7-上报型协议的实现"><a href="#7-上报型协议的实现" class="headerlink" title="7 上报型协议的实现"></a>7 上报型协议的实现</h2><p>与上报型协议相关的函数调用关系如下：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image48.png" alt="Alt text"></p>
<p>函数调用说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>userTimerFunc</strong></td>
<td style="text-align:left">获取用户区的上报型数据</td>
</tr>
<tr>
<td style="text-align:left"><strong>gizwitsHandle</strong></td>
<td style="text-align:left">用户调用该接口可以完成设备数据的变化上报</td>
</tr>
<tr>
<td style="text-align:left"><strong>gizCheckReport</strong></td>
<td style="text-align:left">判断是否上报当前状态的数据</td>
</tr>
<tr>
<td style="text-align:left"><strong>gizDataPoints2ReportData</strong></td>
<td style="text-align:left">完成用户区数据到上报型数据的转换</td>
</tr>
<tr>
<td style="text-align:left"><strong>gagentUploadData</strong></td>
<td style="text-align:left">将上报数据发送给WiFi模块</td>
</tr>
</tbody>
</table>
<h3 id="7-1-只读型数据的获取"><a href="#7-1-只读型数据的获取" class="headerlink" title="7.1 只读型数据的获取"></a>7.1 只读型数据的获取</h3><p>相关代码:<br><strong>app\user\user_main.c</strong> 中 userTimerFunc() 函数：</p>
<p>使用说明：</p>
<p>该函数中完成了用户区上报型数据的获取。<strong>用户只需将读到的数据赋值到用户区当前设备状态结构体</strong>即可：<br><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image49.png" alt="Alt text"></p>
<h3 id="7-2-上报状态判断"><a href="#7-2-上报状态判断" class="headerlink" title="7.2 上报状态判断"></a>7.2 上报状态判断</h3><p>为了让API接口更简化，处理更简单，机智云把更多的判断放到协议模块来处理，达到了开发者只要把状态更新到协议处理模块，不需要关心何时上报，由协议处理模块自动完处理的目的。</p>
<p>相关代码:  </p>
<p><strong>Gizwits\gizwits_protocol.c</strong> 中 <strong>gizCheckReport()</strong> 函数：</p>
<p>功能说明：</p>
<p>根据协议判断是否上报当前状态的数据，判断逻辑如下：</p>
<ol>
<li><p>控制型数据发生状态变化，立刻主动上报当前状态</p>
</li>
<li><p>用户触发或环境变化所产生的, 其发送的频率不能快于6秒每次</p>
</li>
</ol>
<p>协议中说明如下：(“4.9 设备MCU向WiFi模组主动上报当前状态”)</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image50.png" alt="Alt text"></p>
<p>以“逻辑1：控制型数据主动上报当前状态”为例：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image51.png" alt="Alt text"></p>
<p>以“逻辑2：控制型数据主动上报当前状态”为例：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image52.png" alt="Alt text"></p>
<h3 id="7-3-只读型数据类型转换"><a href="#7-3-只读型数据类型转换" class="headerlink" title="7.3 只读型数据类型转换"></a>7.3 只读型数据类型转换</h3><p>获得到用户区的原始数据后，在传输到云端前要进行相应的数据转换，所以要在<strong>gizDataPoints2ReportData</strong>中完成相应的数据的转换。</p>
<p>转换函数说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">gizDataPoints2ReportData</td>
<td style="text-align:left">完成传输数据的压缩处理，详情查看“2.8.2 数据解压与压缩处理”一节。</td>
</tr>
<tr>
<td style="text-align:left">gizY2X</td>
<td style="text-align:left">将用户区数据转化为传输数据，详情查看“2.8.1 数据点类型转换”一节。</td>
</tr>
</tbody>
</table>
<h2 id="8-机智云协议数据处理"><a href="#8-机智云协议数据处理" class="headerlink" title="8 机智云协议数据处理"></a>8 机智云协议数据处理</h2><h3 id="8-1-数据点类型转换"><a href="#8-1-数据点类型转换" class="headerlink" title="8.1 数据点类型转换"></a>8.1 数据点类型转换</h3><p>机智云为使设备功能定义更加简单直接，使用户输入的数值转换成设备能够识别的uint类型，这套算法的核心公式是：y=kx+m （<strong>y：显示值；x：传输值；k：分辨率；m：增量</strong>）</p>
<p>以微信宠物屋的温湿度传感器温度检测为例：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image53.png" alt="Alt text"></p>
<p>取值范围：-13（Ymin） ~ 187（Ymax），分辨率：1，增量：-13 ；</p>
<p>其分辨率、偏移量作为宏定义定义在app\Gizwits\gizwits_product.h中：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image54.png" alt="Alt text"></p>
<p>根据公式：y=kx＋m，k = 1 ; m = -13</p>
<p>实际传输的值：x = (y - m) / k</p>
<p>转换函数在程序中的说明：</p>
<p>A.X2Y的转换：<br><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image55.png" alt="Alt text"></p>
<p>B. Y2X的转换：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image56.png" alt="Alt text"></p>
<p>功能定义更加</p>
<h3 id="8-2-数据解压与压缩处理"><a href="#8-2-数据解压与压缩处理" class="headerlink" title="8.2 数据解压与压缩处理"></a>8.2 数据解压与压缩处理</h3><p>设备端与自云端的数据交互过程中，一些特殊类型（bool和enum类型）的数据点原始数据只有被特殊处理后才可被云端解析，所以设备端在接收云端数据时要进行数据的解压处理；在向云端发送数据时进行数据的<strong>压缩处理</strong>。</p>
<p>机智云已封装出了相应的处理接口：</p>
<table>
<thead>
<tr>
<th style="text-align:left">处理名称</th>
<th style="text-align:left">接口名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">bool和enum类型数据点数据解压</td>
<td style="text-align:left">gizDecompressionValue</td>
</tr>
<tr>
<td style="text-align:left">bool和enum类型数据点数据压缩</td>
<td style="text-align:left">gizCompressValue</td>
</tr>
</tbody>
</table>
<p>以《微信宠物屋》的RGB LED控制为例，云端定义如下：</p>
<p> <img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/57.png" alt="Alt text"></p>
<p>对应文档中数据存储格式如下：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image57.png" alt="Alt text"></p>
<p>字节序与bit序对应代码中宏定义如下：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image58.png" alt="Alt text"></p>
<p>对应的数据点在接收解压时处理如下(位于gizDataPoint2Event函数中)：位于</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image59.png" alt="Alt text"></p>
<p>对应的数据点在发送压缩时处理如下(位于gizDataPoints2ReportData函数中)：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image60.png" alt="Alt text"></p>
<h1 id="相关支持"><a href="#相关支持" class="headerlink" title="相关支持"></a>相关支持</h1><h2 id="1-如果您是开发者"><a href="#1-如果您是开发者" class="headerlink" title="1) 如果您是开发者"></a>1) 如果您是开发者</h2><p>GoKit是面向智能硬件开发者限量免费开放，注册我们的论坛或关注我们的官方微信均可发起申请即可。</p>
<p>开发者论坛： <a href="http://club.gizwits.com/forum.php" target="_blank" rel="noopener">http://club.gizwits.com/forum.php</a></p>
<p>文档中心：<a href="http://docs.gizwits.com" target="_blank" rel="noopener">http://docs.gizwits.com</a></p>
<h2 id="2-如果您是团体"><a href="#2-如果您是团体" class="headerlink" title="2) 如果您是团体"></a>2) 如果您是团体</h2><p>GizWits针对团体有很多支持计划，您可以和GizWtis联系，快速得到GoKit以及技术支持；</p>
<p>网站地址：<a href="http://www.gizwits.com/about-us" target="_blank" rel="noopener">http://www.gizwits.com/about-us</a></p>
<p>官方二维码：</p>
<p><img src="/assets/zh-cn/deviceDev/WiFiSOC/Source/Source_old/image61.png" alt="Alt text"></p>

    </div>
    
    <div class="widget-wrapper">
  <span class="widget">
    <div>
        <a id='share' target="_blank" title="分享">
          <span>分享</span>
        </a>
        <div class="social-share" data-initialized="true">
            <a href="#" class="social-share-icon icon-wechat"></a>
            <a href="#" class="social-share-icon icon-weibo"></a>
            <a href="#" class="social-share-icon icon-qq"></a>
            <a href="#" class="social-share-icon icon-qzone"></a>
            <a href="#" class="social-share-icon icon-douban"></a>
        </div>
    </div>
    <a href="http://y0.cn/docs" target="_blank" title="项目登记">
      <span>项目登记</span>
    </a>
    <a href="https://github.com/gizwits-docs/gizwits-docs/issues" target="_blank" title="问题反馈">
      <span>问题反馈</span>
    </a>
    <a href="#" title="返回顶部"><i class="fa fa-angle-up fa-2x" aria-hidden="true"></i></a>
  </span>
</div>
  </div>
</div>

    <div class="footer">
  <div class="container">
    <p>
      <span><a href="http://www.gizwits.com" target="_blank">机智云首页</a></span>
      <span><a href="http://www.gizwits.com/about-us" target="_blank">关于我们</a></span>
      <span><a href="http://www.gizwits.com/about-us#contact-us" target="_blank">联系我们</a></span>
      <span><a href="http://www.gizwits.com/join-us" target="_blank">加入我们</a></span>
    </p>
    <p>&#169;2011-2017; Gizwits IoT Technology Co., Ltd. 粤ICP备11090211号</p>
  </div>
</div>

    <script src="/js/spin.min.js"></script>
<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.hashchange.min.js"></script>
<script src="/js/clipboard.min.js"></script>
<script src="/js/scrollspy.js"></script>
<script src="/js/social-share.min.js"></script>
<script src="/js/documentation.js?v=d413cf8ceca4865c39c2dabcd3bc0077"></script>


<script type="text/javascript" src="http://webchat.7moor.com/javascripts/7moorInit.js?accessId=b01e0430-943a-11e6-8ad7-636675d9e71f&autoShow=true" async='async'></script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3787e6b3b29a084fde41f22828d89b7d";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>
  </body>
</html>